# MAINNET Gate M5 â€” Launch Dry-Run (Artifact-Only, Proof-Driven)

This runbook is the Gate M5 final product for bringing up **mainnet Seed1 + Seed2 + external Joiner** from release artifacts only.

**Locked doctrine (must not drift):**
- Mainnet genesis hash: `692a347dab52762df864509bc9b0972408d9dc778ef0851190b18bb1555e1be5`
- Testnet genesis hash: `1b9c1803328d95518a0fd921ce8fd1d5f93c9a88ca02c0b1440248effc763159`
- Mainnet mode must be started with `--network mainnet --genesis /path/to/genesis-mainnet.json`

---

## 0) Preflight (MUST pass before bootstrap)

### 0.1 Host requirements
- Linux host (Ubuntu/Oracle-class VPS)
- `bash`, `curl`, `tar`, `sha256sum`, `awk`, `sed`, `grep`, `ss`, `nc`
- Open inbound TCP for P2P on each node (default mainnet P2P `9040`)
- Keep RPC private by default (bind `127.0.0.1:18040`)

### 0.2 Ports and network policy
Default mainnet ports (do not use testnet `9030`):
- `MAINNET_P2P_PORT=9040`
- `MAINNET_RPC_PORT=18040`

Firewall example (`ufw`):
```bash
sudo ufw allow 9040/tcp
sudo ufw deny 18040/tcp
sudo ufw status verbose
```

iptables example:
```bash
sudo iptables -A INPUT -p tcp --dport 9040 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 18040 -s 127.0.0.1 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 18040 -j DROP
```

### 0.3 Prepare env file per host
```bash
sudo mkdir -p /etc/kexa
sudo cp deploy/mainnet/env.example /etc/kexa/mainnet.env
sudoedit /etc/kexa/mainnet.env
```
Set host-specific values: `SEED1_PUBLIC_P2P_IP`, `SEED2_PUBLIC_P2P_IP`, ports, dirs.

Run preflight on each host:
```bash
bash deploy/mainnet/scripts/m5_preflight.sh /etc/kexa/mainnet.env
```
Expected: only `PASS` lines.

---

## 1) Artifact-only install contract (Seed1, Seed2, Joiner)

Copy artifacts from release machine to each host (example):
```bash
scp dist/{kexa-node-0.1.0-rc1-x86_64-linux.tar.gz,kexa-cli-0.1.0-rc1-x86_64-linux.tar.gz,genesis-mainnet.json,SHA256SUMS,MAINNET_GENESIS.txt,BUILD_MANIFEST.txt} user@HOST:/opt/kexa/artifacts/
```

### CHECK 1 (after copy): SHA verification
```bash
cd /opt/kexa/artifacts
sha256sum -c SHA256SUMS
```
PASS criteria: all listed files return `OK`.

---

## 2) Seed1 bootstrap and launch

### 2.1 Bootstrap Seed1
```bash
sudo bash deploy/mainnet/scripts/m5_seed_bootstrap.sh /etc/kexa/mainnet.env seed1
```
This script performs:
- CHECK 1: `SHA256SUMS` verification
- CHECK 2: extraction/install + `--print-genesis` verification against locked mainnet/testnet hashes
- data-dir safety guard (fails on ambiguous/mismatched existing mainnet dir)

### CHECK 2 (manual verify for operator confidence)
```bash
/opt/kexa/bin/kexa-node --network mainnet --genesis /etc/kexa/genesis-mainnet.json --print-genesis
/opt/kexa/bin/kexa-node --network testnet --print-genesis
```
PASS criteria:
- mainnet prints `692a347dab52762df864509bc9b0972408d9dc778ef0851190b18bb1555e1be5`
- testnet prints `1b9c1803328d95518a0fd921ce8fd1d5f93c9a88ca02c0b1440248effc763159`

### 2.2 Start Seed1 node
Run the command generated by bootstrap (`run-command.txt` in proof dir), example:
```bash
/opt/kexa/bin/kexa-node --network mainnet --genesis /etc/kexa/genesis-mainnet.json --data-dir /var/lib/kexa/mainnet --rpc-addr 127.0.0.1:18040 --p2p-addr 0.0.0.0:9040 --peers SEED2_IP:9040
```

---

## 3) Seed2 bootstrap and launch

### 3.1 Bootstrap Seed2
```bash
sudo bash deploy/mainnet/scripts/m5_seed_bootstrap.sh /etc/kexa/mainnet.env seed2
```

### 3.2 Start Seed2 node
Use generated run command, example:
```bash
/opt/kexa/bin/kexa-node --network mainnet --genesis /etc/kexa/genesis-mainnet.json --data-dir /var/lib/kexa/mainnet --rpc-addr 127.0.0.1:18040 --p2p-addr 0.0.0.0:9040 --peers SEED1_IP:9040
```

### CHECK 3 (Seed1/Seed2 stable + peering proof)
Run on both seeds (via local shell or SSH tunnel to localhost RPC):
```bash
curl -fsS http://127.0.0.1:18040/health
curl -fsS http://127.0.0.1:18040/tip
curl -fsS "http://127.0.0.1:18040/blocks?limit=1"
curl -fsS http://127.0.0.1:18040/peers/live
```
PASS criteria:
- `/health` returns `ok`
- `/tip` includes `height` + `hash`
- `/blocks?limit=1` contains genesis hash `692a347d...1be5`
- `/peers/live` is non-empty on at least one seed (preferably both)

Optional automated check per node:
```bash
bash deploy/mainnet/scripts/m5_verify_rpc.sh http://127.0.0.1:18040 692a347dab52762df864509bc9b0972408d9dc778ef0851190b18bb1555e1be5 /var/lib/kexa/proof/manual-seed-check
```

---

## 4) External Joiner bootstrap + proof

On a third host (Joiner), copy the same release artifacts into `ARTIFACT_DIR`.

### 4.1 Bootstrap joiner
```bash
sudo bash deploy/mainnet/scripts/m5_joiner_bootstrap.sh /etc/kexa/mainnet.env
```

### 4.2 Start joiner
Use generated run command, example:
```bash
/opt/kexa/bin/kexa-node --network mainnet --genesis /etc/kexa/genesis-mainnet.json --data-dir /var/lib/kexa/mainnet --rpc-addr 127.0.0.1:18040 --p2p-addr 0.0.0.0:9040 --peers SEED1_IP:9040,SEED2_IP:9040
```

### CHECK 3 (external join proof)
On joiner:
```bash
curl -fsS http://127.0.0.1:18040/peers/live
```
Must be non-empty.

On Seed1 and Seed2:
```bash
curl -fsS http://127.0.0.1:18040/peers/live
```
Must show non-empty peer list including external connectivity after joiner starts.

Collect full proof bundle from any operator host that can reach all three RPC endpoints:
```bash
bash deploy/mainnet/scripts/m5_collect_proof.sh /etc/kexa/mainnet.env http://SEED1_RPC_HOST:18040 http://SEED2_RPC_HOST:18040 http://JOINER_RPC_HOST:18040
```
PASS criteria:
- script prints PASS lines
- writes bundle under `PROOF_ROOT/m5-proof-bundle-<timestamp>/`
- includes health/tip/blocks/peers evidence for seed1, seed2, joiner

---

## 5) Wrong-network data-dir safety demonstration (required)

Expected behavior: node fails fatally if existing data dir has different genesis/network.

### Demo procedure
1. Start testnet once in a throwaway dir:
```bash
mkdir -p /tmp/kexa-demo-mismatch
/opt/kexa/bin/kexa-node --network testnet --data-dir /tmp/kexa-demo-mismatch --rpc-addr 127.0.0.1:28030 --p2p-addr 0.0.0.0:29030
```
Stop it.

2. Attempt mainnet in same dir:
```bash
/opt/kexa/bin/kexa-node --network mainnet --genesis /etc/kexa/genesis-mainnet.json --data-dir /tmp/kexa-demo-mismatch --rpc-addr 127.0.0.1:18040 --p2p-addr 0.0.0.0:9040
```

PASS criteria (safety works): process exits with fatal mismatch/network guard.

Fix path:
```bash
rm -rf /tmp/kexa-demo-mismatch
mkdir -p /var/lib/kexa/mainnet
```
Then start mainnet with clean dir.

---

## 6) Failure Playbook (Troubleshooting)

### command not found
- Verify installed binaries:
```bash
ls -l /opt/kexa/bin/kexa-node /opt/kexa/bin/kexa-cli
```
- Run via absolute path or add to PATH:
```bash
export PATH="/opt/kexa/bin:$PATH"
```

### port already in use
```bash
ss -ltnp | grep -E ':9040|:18040'
```
Change `*_P2P_PORT`/`*_RPC_PORT` in `/etc/kexa/mainnet.env`, restart.

### firewall blocked
- From remote host:
```bash
nc -vz SEED1_PUBLIC_IP 9040
```
- Local RPC check:
```bash
curl -fsS http://127.0.0.1:18040/health
```
If P2P blocked, open inbound TCP/9040 on host and cloud security group.

### seeds not peering
- Confirm `--peers` points to correct public IP:port.
- Confirm both seeds listen on `0.0.0.0:9040`:
```bash
ss -ltnp | grep 9040
```
- Check `/peers/live` repeatedly after both nodes run.

### RPC not reachable
Default should be localhost only. Use SSH tunnel:
```bash
ssh -L 18040:127.0.0.1:18040 user@SEED1_HOST
curl -fsS http://127.0.0.1:18040/health
```

### wrong genesis / mismatch
- Re-run CHECK 2 `--print-genesis` commands.
- Verify `/etc/kexa/genesis-mainnet.json` source file.
- If mismatch guard triggers, wipe wrong dir intentionally:
```bash
rm -rf /var/lib/kexa/mainnet
mkdir -p /var/lib/kexa/mainnet
```

### Docker permission issues
- Ensure host data dir owned by container UID/GID 10001:
```bash
sudo chown -R 10001:10001 /var/lib/kexa/mainnet
```

### systemd failure investigation
```bash
sudo systemctl status kexa-mainnet.service
sudo journalctl -u kexa-mainnet.service -n 200 --no-pager
```

### collect logs/proof bundle for escalation
```bash
bash deploy/mainnet/scripts/m5_collect_proof.sh /etc/kexa/mainnet.env http://127.0.0.1:18040 http://SEED2_RPC:18040 http://JOINER_RPC:18040
```
Attach:
- generated proof bundle directory
- relevant `journalctl` output
- env values (redact secrets)

---

## 7) Gate M5 PASS/FAIL checklist

M5 is **PASS** only if all are true:
1. Seed1 + Seed2 booted from release artifacts only with clean mainnet data dir.
2. Seed-to-seed peering proven (`/peers/live` non-empty).
3. External join proven (joiner `/peers/live` non-empty, seeds also show non-empty after join).
4. Verification contract proven (`/health`, `/tip`, `/blocks?limit=1` genesis lock, `/peers/live`).
5. Wrong-network data-dir safety demonstrated with failure + remediation.

If any item fails, result is **FAIL** and launch is blocked until corrected.
